<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapLibre with Custom Tile Server</title>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
    <!-- Mapbox Draw Library -->
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw/dist/mapbox-gl-draw.css">

    <style>
        body,
        html {
            margin: 0;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #coordinates {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            font-family: Arial, sans-serif;
            z-index: 999;
        }

        #sidebar {
            position: absolute;
            top: 52px;
            left: 10px;
            width: 250px;
            height: 400px;
            background: white;
            overflow-y: auto;
            padding: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #transit-list {
            list-style: none;
            padding: 0;
        }

        #transit-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button id="draw-point">Draw Point</button>
        <button id="draw-line">Draw Line</button>
        <button id="draw-polygon">Draw Polygon</button>
        <button id="clear-drawings">Clear</button>
    </div>

    <pre id="coordinates" class="coordinates"></pre>

    <div id="county-selector">
        <select id="county-dropdown">
            <option value="">Select County</option>
            <!-- Dynamic options will be added here -->
        </select>
    </div>

    <div id="sidebar">
        <h3>Transit Information</h3>
        <ul id="transit-list"></ul> List of transit items
    </div>

    <div id="map"></div>
    <script>
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                "version": 8,
                "sources": {
                    "custom-tiles": {
                        "type": "vector",
                        "tiles": ["https://victor.tftservice.no/data/norway-vector/{z}/{x}/{y}.pbf"],
                        "minzoom": 0,
                        "maxzoom": 14
                    }
                },
                "glyphs": "https://fonts.undpgeohub.org/fonts/{fontstack}/{range}.pbf",
                "layers": [
                    {
                        "id": "roads-layer",
                        "type": "line",
                        "source": "custom-tiles",
                        "source-layer": "transportation",  // üöó Roads Layer
                        "paint": {
                            "line-color": "#B0BEC5",
                            "line-width": 3
                        }
                    },
                    {
                        "id": "forest-layer",
                        "type": "fill",
                        "source": "custom-tiles",
                        "source-layer": "landcover",  // üå≤ Forests Layer
                        "paint": {
                            "fill-color": "#6aeb86",
                            "fill-opacity": 0.5
                        }
                    },
                    {
                        "id": "water",
                        "type": "fill",
                        "source": "custom-tiles",
                        "source-layer": "water",  // water Layer
                        "paint": {
                            "fill-color": "#64B5F6",
                            "fill-opacity": 0.5
                        }
                    },
                    {
                        "id": "landuse",
                        "type": "fill",
                        "source": "custom-tiles",
                        "source-layer": "landuse",  // human Layer
                        "paint": {
                            "fill-color": "#FFD54F",
                            "fill-opacity": 0.5
                        }
                    },
                    {
                        "id": "landcover",
                        "type": "fill",
                        "source": "custom-tiles",
                        "source-layer": "landcover",  // land Layer
                        "paint": {
                            "fill-color": "#e0ddb8",
                            "fill-opacity": 0.5
                        }
                    },
                    {
                        "id": "place",
                        "type": "symbol",
                        "source": "custom-tiles",
                        "source-layer": "place",  // sted Layer
                        "layout": {
                            "text-field": ["get", "name"],
                            "text-font": ['Roboto Regular'],
                            "text-size": 12,
                            "text-allow-overlap": false,
                            "text-max-width": 8,
                            "symbol-spacing": 500
                        },
                        "paint": {
                            "text-color": "#000000",
                            "text-halo-color": "#FFFFFF",
                            "text-halo-width": 2,
                            "text-opacity": 1
                        }
                    },
                    {
                        "id": "building",
                        "type": "fill",
                        "source": "custom-tiles",
                        "source-layer": "building",  // bygning Layer
                        "paint": {
                            "fill-color": "#A1887F",
                            "fill-opacity": 0.5
                        }
                    },
                    {
                        "id": "transportation_name",
                        "type": "symbol",
                        "source": "custom-tiles",
                        "source-layer": "transportation_name",  // navn p√• veier Layer
                        "layout": {
                            "text-field": ["get", "name"],
                            "text-font": ['Roboto Regular'],
                            "text-size": 12,
                            "text-allow-overlap": false,
                            "text-max-width": 8,
                            "symbol-spacing": 500
                        },
                        "paint": {
                            "text-color": "#000000",
                            "text-halo-color": "#FFFFFF",
                            "text-halo-width": 2,
                            "text-opacity": 1
                        }
                    },
                    {
                        "id": "boundary",
                        "type": "line",
                        "source": "custom-tiles",
                        "source-layer": "boundary",  // grense Layer
                        "paint": {
                            "line-color": "#b84600",
                            "line-width": 0.5
                        }
                    }
                ]
            },
            center: [18.9553, 69.6496],  // Troms√∏
            zoom: 10
        });

        const draw = new MapboxDraw({
            displayControlsDefault: false,

            styles: [
                {
                    "id": "gl-draw-point",
                    "type": "circle",
                    "filter": ["==", "$type", "Point"],

                },
                {
                    "id": "gl-draw-line",
                    "type": "line",
                    "filter": ["==", "$type", "LineString"],
                    "paint": {
                        "line-color": "#FF0000",
                        "line-width": 3,
                        "line-dasharray": [0.2, 2]
                    }
                },
                {
                    "id": "gl-draw-polygon-fill",
                    "type": "fill",
                    "filter": ["==", "$type", "Polygon"],
                    "paint": {
                        "fill-color": "#FF0000",
                        "fill-opacity": 0.3
                    }
                },
                {
                    "id": "gl-draw-polygon-stroke",
                    "type": "line",
                    "filter": ["==", "$type", "Polygon"],
                    "paint": {
                        "line-color": "#FF0000",
                        "line-width": 2
                    }
                }
            ]
        });
        map.addControl(draw);

        const coordinates = document.getElementById('coordinates');
        function addPointLayer(data, selectedCounty) {
            // Filter points based on county
            const filteredPoints = data.features.filter(f => f.geometry.type === "Point" && f.properties?.county?.toLowerCase().includes(selectedCounty.toLowerCase()));

            if (map.getSource("locations")) {
                map.removeLayer("locations-layer");
                map.removeSource("locations");
            }

            map.addSource("locations", {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": filteredPoints
                }
            });

            map.addLayer({
                "id": "locations-layer",
                "type": "circle",
                "source": "locations",
                "paint": {
                    "circle-radius": 6,
                    "circle-color": [
                        'match',
                        ['get', 'severity'],
                        'none', '#7e4da3',
                        'low', '#FFFF00',
                        'high', '#FFA500',
                        'highest', '#FF0000',
                        'unknown', '#808080',
                        '#0000FF'
                    ]
                },
                "layout": {
                    "visibility": filteredPoints.length > 0 ? "visible" : "none"  // Set visibility based on filtered points
                }
            });
        }


        function addLineLayer(data, selectedCounty) {
            // Filter lines based on county
            const filteredLines = data.features.filter(f => f.geometry.type === "LineString" && f.properties?.county?.toLowerCase().includes(selectedCounty.toLowerCase()));

            if (filteredLines.length === 0) {
                console.error("‚ùå No LineString features found!");
                return;
            }

            if (map.getSource("line")) {
                map.removeLayer("line-layer");
                map.removeSource("line");
            }

            map.addSource("line", {
                "type": "geojson",
                "data": {
                    "type": "FeatureCollection",
                    "features": filteredLines
                }
            });

            map.addLayer({
                "id": "line-layer",
                "type": "line",
                "source": "line",
                "paint": {
                    "line-color": [
                        'match',
                        ['get', 'severity'],
                        'none', '#7e4da3',
                        'low', '#FFFF00',
                        'high', '#FFA500',
                        'highest', '#FF0000',
                        'unknown', '#808080',
                        '#0000FF'
                    ],
                    "line-width": 4
                },
                "layout": {
                    "visibility": filteredLines.length > 0 ? "visible" : "none"  // Set visibility based on filtered lines
                }
            });
        }


        map.on('draw.create', (e) => {
            const feature = e.features[0];
            if (!feature) return;

            let coords = [];
            if (feature.geometry.type === 'Point') {
                coords = feature.geometry.coordinates;
            } else if (feature.geometry.type === 'LineString') {
                coords = feature.geometry.coordinates;
            } else if (feature.geometry.type === 'Polygon') {
                coords = feature.geometry.coordinates[0];
            }

            if (coords.length > 0) {
                coordinates.innerHTML = `Coordinates:<br />${coords.map(coord => `Lng: ${coord[0].toFixed(5)}, Lat: ${coord[1].toFixed(5)}`).join('<br />')}`;

                new maplibregl.Popup()
                    .setLngLat(coords[0])
                    .setHTML(`<strong>Coordinates:</strong><br>Lng: ${coords[0][0].toFixed(5)}<br>Lat: ${coords[0][1].toFixed(5)}`)
                    .addTo(map);
            }
        });




        document.getElementById("draw-point").addEventListener("click", () => {
            draw.changeMode("draw_point");
        });
        document.getElementById("draw-line").addEventListener("click", () => {
            draw.changeMode("draw_line_string");
        });
        document.getElementById("draw-polygon").addEventListener("click", () => {
            draw.changeMode("draw_polygon");
        });
        document.getElementById("clear-drawings").addEventListener("click", () => {
            draw.deleteAll();
            coordinates.innerHTML = '';
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                draw.changeMode("simple_select");
            }
        });

        // Adjust this function to toggle individual points' visibility
        function togglePointVisibility(id, isVisible) {
            const visibility = isVisible ? 'visible' : 'none';
            map.setLayoutProperty('locations-layer', 'visibility', visibility);
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetch("http://127.0.0.1:8000/api/locations/")
                .then(response => response.json())
                .then(data => {
                    console.log("üì° API Response:", data);

                    if (!data || !Array.isArray(data.features)) {
                        console.error("‚ùå Unexpected data format:", data);
                        return;
                    }

                    const counties = new Set();
                    data.features.forEach(location => {
                        if (location.properties && location.properties.county) { // Adjust based on data structure
                            counties.add(location.properties.county);
                        }
                    });

                    const countyDropdown = document.getElementById("county-dropdown");
                    countyDropdown.innerHTML = '<option value="">Select County</option>'; // Reset

                    counties.forEach(county => {
                        const option = document.createElement("option");
                        option.value = county;
                        option.textContent = county;
                        countyDropdown.appendChild(option);
                    });

                    console.log("‚úÖ County dropdown populated.");
                })
                .catch(error => console.error("‚ùå Error fetching locations:", error));
        });

        document.getElementById("county-dropdown").addEventListener("change", function () {
            const selectedCounty = this.value;

            if (selectedCounty) {
                fetch("http://127.0.0.1:8000/api/locations/")
                    .then(response => response.json())
                    .then(data => {
                        console.log("üì° API Response:", data);

                        // Filter locations based on selected county
                        const filteredLocations = data.features.filter(location => {
                            const areaName = location.properties?.county; // Use correct key
                            return areaName && areaName.trim().toLowerCase().includes(selectedCounty.trim().toLowerCase());
                        });

                        console.log(`üöÄ Showing data for: ${selectedCounty}`, filteredLocations);

                        if (map.getSource("locations")) {
                            map.removeLayer("locations-layer");
                            map.removeSource("locations");
                        }

                        // Add filtered points
                        addPointLayer(data, selectedCounty);

                        // Add filtered lines
                        addLineLayer(data, selectedCounty);

                        // Adjust map view to focus on the selected county
                        if (filteredLocations.length > 0) {
                            const firstLocation = filteredLocations[0];
                            map.flyTo({
                                center: firstLocation.geometry.coordinates,
                                zoom: 9
                            });
                        } else {
                            console.warn(`‚ùå No data found for ${selectedCounty}`);
                        }
                    })
                    .catch(error => console.error("‚ùå Error fetching data for selected county:", error));
            }
        });





        document.addEventListener('DOMContentLoaded', function () {
            fetch("http://127.0.0.1:8000/api/locations/")
                .then(response => response.json())
                .then(data => {
                    console.log("GeoJSON Data:", location.Comment);

                    const transitList = document.getElementById("transit-list");

                    if (!transitList) {
                        console.error("‚ùå 'transit-list' element not found in the document!");
                        return;
                    }

                    // Clear existing items in the list
                    transitList.innerHTML = "";

                    // üîπ ADD POINT LOCATIONS
                    if (map.getSource("locations")) {
                        map.removeLayer("locations-layer");
                        map.removeSource("locations");
                    }

                    // Add severity-based coloring for points
                    map.addSource("locations", {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": data.features.filter(f => f.geometry.type === "Point")
                        }
                    });

                    map.addLayer({
                        "id": "locations-layer",
                        "type": "circle",
                        "source": "locations",
                        "paint": {
                            "circle-radius": 6,
                            "circle-color": [
                                'match',
                                ['get', 'severity'],
                                'none', '#7e4da3',  // Light Grey for 'none'
                                'low', '#FFFF00',    // Yellow for 'low'
                                'high', '#FFA500',   // Orange for 'high'
                                'highest', '#FF0000',// Red for 'highest'
                                'unknown', '#808080',// Gray for 'unknown'
                                '#0000FF'            // Default Blue if no severity matches
                            ]
                        },
                        "layout": {
                            "visibility": "visible"  // Start with the layer hidden
                        }
                    });

                    // üîπ ADD POPUPS ON CLICK
                    map.on('click', 'locations-layer', function (e) {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const name = e.features[0].properties.name;
                        const description = e.features[0].properties.description || "No description available.";
                        const severity = e.features[0].properties.severity || "Unknown";
                        const comment = e.features[0].properties.comment

                        new maplibregl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(`
                        <div style="font-family: Arial, sans-serif; padding: 10px; max-width: 200px;">
                            <h3 style="margin: 0; font-size: 18px;">${name}</h3>
                            <p style="margin: 5px 0;">${description}</p>
                            <p style="margin: 5px 0;"><strong>Severity:</strong> ${severity}</p>
                            <p style="margin: 5px 0;"><strong>Comment:</strong> ${comment}</p>
                        </div>
                    `)
                            .addTo(map);
                    });

                    // üîπ ADD CHECKBOXES FOR TRANSIT LIST
                    data.features.forEach(item => {
                        if (item.geometry.type !== "Point") return; // Only handle point features
                        const listItem = document.createElement("li");

                        const label = document.createElement("label");
                        label.textContent = item.properties.name;

                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.checked = true;
                        checkbox.addEventListener("change", () => {
                            togglePointVisibility(item.properties.id, checkbox.checked);
                        });

                        listItem.appendChild(label);
                        listItem.appendChild(checkbox);
                        transitList.appendChild(listItem);
                    });



                    // üîπ ADD LINES
                    const lineFeatures = data.features.filter(f => f.geometry.type === "LineString");

                    if (lineFeatures.length === 0) {
                        console.error("‚ùå No LineString features found!");
                        return;
                    }

                    console.log(`‚úÖ Found ${lineFeatures.length} LineString features!`, lineFeatures);

                    // üîπ REMOVE OLD LINE LAYER IF IT EXISTS
                    if (map.getSource("line")) {
                        map.removeLayer("line-layer");
                        map.removeSource("line");
                    }

                    // Add severity-based coloring for lines
                    map.addSource("line", {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": lineFeatures
                        }
                    });

                    map.addLayer({
                        "id": "line-layer",
                        "type": "line",
                        "source": "line",
                        "paint": {
                            "line-color": [
                                'match',
                                ['get', 'severity'],
                                'none', '#7e4da3',  // Light Grey for 'none'
                                'low', '#FFFF00',    // Yellow for 'low'
                                'high', '#FFA500',   // Orange for 'high'
                                'highest', '#FF0000',// Red for 'highest'
                                'unknown', '#808080',// Gray for 'unknown'
                                '#0000FF'            // Default Blue if no severity matches
                            ],
                            "line-width": 4
                        }
                    });

                    console.log("‚úÖ Line layer added successfully!");
                })
                .catch(error => console.error("‚ùå Error fetching locations:", error));
        });



    </script>
</body>

</html>